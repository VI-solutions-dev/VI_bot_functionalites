<?xml version="1.0" encoding="UTF-8"?>

<launch>
    <!-- Arguments for launch file with defaults provided -->
    <arg name="database_path" default="rtabmap.db"/>
    <arg name="rgb_topic" default="/camera/rgb/image_color"/> <!-- Update this if the topic name is different -->
    <arg name="depth_topic" default="/camera/depth/image"/> <!-- Update this if the topic name is different -->
    <arg name="camera_info_topic" default="/camera/rgb/camera_info"/>
    <arg name="frame_id" default="camera_link"/> <!-- Update this to match the actual frame ID -->
    <arg name="wait_for_transform" default="0.2"/> 

    <!-- Choose visualization -->
    <arg name="rviz" default="true"/>
    <arg name="rtabmapviz" default="true"/> 
 
    <!-- Localization-only mode -->
    <arg name="localization" default="false" args="--delete_db_on_start"/>
    <arg if="$(arg localization)" name="rtabmap_args" default=""/>
    <arg unless="$(arg localization)" name="rtabmap_args" default=""/>
  
    <!-- Mapping Node -->
    <group ns="rtabmap">
        <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen" args="$(arg rtabmap_args)">
            <!-- Basic RTAB-Map Parameters -->
            <param name="database_path" type="string" value="$(arg database_path)"/>
            <param name="frame_id" type="string" value="$(arg frame_id)"/>
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)"/>
            <param name="map_negative_poses_ignored" type="bool" value="true"/>
            <param name="Grid/FromDepth" type="string" value="true"/>
            <remap from="scan" to="/scan"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="depth/image" to="$(arg depth_topic)"/>
            <remap from="odom" to="/odom"/>
            <remap from="grid_map" to="/map"/>
            <param name="Reg/Force3DoF" type="string" value="true"/>      
            <param name="queue_size" type="int" value="20"/>
            <param name="Kp/DetectorStrategy" type="string" value="0"/> 
            <param name="Kp/MaxFeatures" type="string" value="400"/>  
            <param name="SURF/HessianThreshold" type="string" value="100"/>
            <param name="Reg/Strategy" type="string" value="0"/> 
            <param name="Vis/MinInliers" type="string" value="15"/> 
            <param name="Mem/NotLinkedNodesKept" type="string" value="false"/>
            <param if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false"/>
            <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true"/>
            <param name="Mem/IncrementalMemory" type="string" value="$(arg localization)"/>
        </node> 
   
        <!-- visualization with rtabmapviz -->
        <node if="$(arg rtabmapviz)" pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" args="-d $(find rtabmap_ros)/launch/config/rgbd_gui.ini" output="screen">
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="frame_id" type="string" value="$(arg frame_id)"/>
            <param name="wait_for_transform" type="bool" value="true"/>
            <param name="queue_size" type="int" value="10"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="scan" to="/scan"/>
            <remap from="odom" to="/odom"/>
            <param name="rgb/image_transport" type="string" value="compressed"/>
            <param name="depth/image_transport" type="string" value="compressedDepth"/>
        </node>

        <!-- Visualisation RVIZ -->
        <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(find rtabmap_ros)/launch/config/rgbd_gui.ini" output="screen">
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="frame_id" type="string" value="$(arg frame_id)"/>
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <remap from="scan" to="/scan"/>
        </node>
    </group>
</launch>
