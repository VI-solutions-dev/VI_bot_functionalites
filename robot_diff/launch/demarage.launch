<launch>
  <!-- ================== ARGS ================== -->
  <arg name="model"                default="dd_robot6.urdf"/>
  <arg name="use_rtabmapviz"       default="true"/>
  <arg name="use_vo"               default="true"/>   <!-- visual odom node -->
  <arg name="use_ekf"              default="true"/>
  <arg name="virtual_scan"         default="true"/>
  <arg name="rviz_config"          default="$(find robot_diff)/urdf.rviz"/>
  <arg name="db_path"              default="$(env HOME)/.ros/rtabmap.db"/>

  <!-- ================== ROBOT DESCRIPTION ================== -->
  <param name="robot_description" textfile="$(find robot_diff)/urdf/$(arg model)"/>

  <node name="joint_state_publisher" pkg="joint_state_publisher" type="joint_state_publisher"/>
  <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher"/>

  <!-- ===== STATIC TF: base_link -> camera_link (EDIT the 6 numbers!) ===== -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="cam_tf"
        args="0.2 0 0.1 0 0 0 base_link camera_link"/>

  <node pkg="topic_tools" type="relay" name="grid_map_relay" output="screen" args="/rtabmap/grid_map /map" />
  <!-- ===== diff_tf disabled (don't publish odom->base_link) -->
  <node pkg="robot_diff" type="diff_tf.py" name="diff_tf" output="screen">
    <param name="publish_tf" value="false"/>
  </node>

  <!-- ===== Trajectory viz ===== -->
  <node name="robot_trajectory_visualization"
        pkg="robot_diff"
        type="trajectory_visualization.py"
        output="screen"/>

  <!-- ===== Rosbridge ===== -->
  <include file="$(find rosbridge_server)/launch/rosbridge_websocket.launch">
    <arg name="port" value="9090"/>
  </include>

  <!-- ===== RViz ===== -->
  <node name="rviz" pkg="rviz" type="rviz"
        args="-d $(arg rviz_config)"
        required="true" />

  <param name="use_sim_time" value="false"/>

  <!-- ================== VISUAL ODOMETRY (rgbd_odometry) ================== -->
  <group if="$(arg use_vo)">
    <node pkg="rtabmap_odom" type="rgbd_odometry" name="rgbd_odometry" output="screen">
      <!-- Frames -->
      <param name="frame_id" value="base_link"/>
      <param name="odom_frame_id" value="odom_vo"/>
      <param name="publish_tf" value="false"/>

      <!-- Help VO stick using motion guess -->
      <param name="Odom/GuessMotion" value="true"/>

      <!-- Advanced VO tuning (from Advanced Parameter Tuning) -->
      <param name="Odom/Strategy" value="0"/>          <!-- F2F odometry -->
      <param name="Vis/CorType" value="0"/>            <!-- Optical flow -->
      <param name="OdomF2M/MaxSize" value="1000"/>     <!-- F2M feature buffer -->
      <param name="Vis/MaxFeatures" value="1000"/>      <!-- per-image features -->
      <param name="GFTT/MinDistance" value="40"/>      <!-- for â‰¥720p images -->
      <param name="Reg/Force3DoF" value="true"/>       <!-- planar odom -->
      <!-- Your thresholds/features kept -->
      <param name="Odom/MinInliers"  value="12"/>
      <param name="Vis/MinInliers"   value="12"/>
      <param name="Kp/MaxFeatures"   value="1500"/>
      <param name="Odom/FilteringStrategy"   value="1"/>
      <!-- Sync tuning -->
      <param name="approx_sync" value="true"/>
      <param name="approx_sync_max_interval" value="0.05"/>

      <!-- Auto reset after 1 bad frame -->
      <param name="Odom/ResetCountdown" value="20"/>

      <!-- Feed EKF odom as guess -->
      <remap from="odom" to="/odom"/>

      <!-- Camera topics -->
      <remap from="rgb/image"       to="/camera/rgb/image_color"/>
      <remap from="depth/image"     to="/camera/depth/image"/>
      <remap from="rgb/camera_info" to="/camera/rgb/camera_info"/>
    </node>
  </group>

  <!-- ================== EKF (robot_localization) ================== -->
  <group if="$(arg use_ekf)">
    <node pkg="robot_localization"
          type="ekf_localization_node"
          name="ekf_odom"
          output="screen">
      <param name="publish_tf" value="true"/> 
      <remap from="odometry/filtered" to="/odom"/>
      <rosparam file="$(find robot_diff)/params/ekf.yaml" command="load"/>
    </node>
  </group>

  <!-- ================== RTAB-Map SLAM ================== -->
  <include file="$(find rtabmap_ros)/launch/rtabmap.launch">
<!-- Inputs & frames -->
<arg name="odom_topic"   value="/odom"/>

    <!-- Frames -->
<arg name="frame_id"      value="base_link"/>
<arg name="odom_frame_id" value="odom"/>
<param name="subscribe_depth" value="true"/>
<param name="subscribe_scan"  value="true"/>
<param name="queue_size"      value="10"/>
<remap from="rgb/image"               to="/camera/rgb/image_rect_color"/>
<remap from="depth/image"             to="/camera/depth_registered/image_raw"/>
<remap from="rgb/camera_info"         to="/camera/rgb/camera_info"/>
<remap from="scan"                    to="/scan"/>
<remap from="odom"                    to="/odom"/>

<!-- Behavior (IROS-2014 style) -->
<param name="Reg/Force3DoF"             value="true"/>
<param name="RGBD/ProximityBySpace"     value="false"/>
<param name="RGBD/AngularUpdate"        value="0.01"/>
<param name="RGBD/LinearUpdate"         value="0.01"/>
<param name="RGBD/OptimizeFromGraphEnd" value="false"/>

<!-- Loop-closure cleanup & robustness -->
<param name="Kp/RoiRatios"              value="0 0 0 0.3"/>  <!-- ignore bottom 30% (floor) -->
<param name="Kp/MaxDepth"               value="4"/>
<param name="LccBow/Force2D"            value="true"/>
<param name="LccBow/InlierDistance"     value="0.05"/>
<param name="LccBow/MaxDepth"           value="4"/>
<param name="LccBow/MinInliers"         value="3"/>

<!-- Loop-closure ICP refinement -->
<param name="LccIcp/Type"                        value="2"/>
<param name="LccIcp/MaxDistance"                 value="0.2"/>
<param name="LccIcp2/CorrespondenceRatio"        value="0.5"/>
<param name="LccIcp2/Iterations"                 value="30"/>
<param name="LccIcp2/MaxCorrespondenceDistance"  value="0.1"/>
<param name="LccIcp2/MaxFitness"                 value="1"/>
<param name="LccIcp2/VoxelSize"                  value="0"/>
<param name="LccIcp3/Decimation"                 value="8"/>
<param name="LccIcp3/Iterations"                 value="30"/>
<param name="LccIcp3/MaxCorrespondenceDistance"  value="0.05"/>
<param name="LccIcp3/MaxDepth"                   value="4"/>
<param name="LccIcp3/MaxFitness"                 value="1"/>
<param name="LccIcp3/Samples"                    value="0"/>
<param name="LccIcp3/VoxelSize"                  value="0.005"/>

<!-- Your CORE params (GUI section excluded) -->
<param name="BRIEF/Bytes"                 value="32"/>
<param name="Bayes/FullPredictionUpdate"  value="true"/>
<param name="Bayes/PredictionLC"          value="0.1 0.36 0.30 0.16 0.062 0.0151 0.00255 0.000324 2.5e-05 1.3e-06 4.8e-08 1.2e-09 1.9e-11 2.2e-13 1.7e-15 8.5e-18 2.9e-20 6.9e-23"/>
<param name="Bayes/VirtualPlacePriorThr"  value="0.9"/>
<param name="DbSqlite3/CacheSize"         value="10000"/>
<param name="DbSqlite3/InMemory"          value="false"/>
<param name="DbSqlite3/JournalMode"       value="3"/>
<param name="DbSqlite3/Synchronous"       value="0"/>
<param name="DbSqlite3/TempStore"         value="2"/>
<param name="FAST/Gpu"                    value="false"/>
<param name="FAST/GpuKeypointsRatio"      value="0.05"/>
<param name="FAST/NonmaxSuppression"      value="true"/>
<param name="FAST/Threshold"              value="30"/>
<param name="FREAK/NOctaves"              value="4"/>
<param name="FREAK/OrientationNormalized" value="true"/>
<param name="FREAK/PatternScale"          value="22"/>
<param name="FREAK/ScaleNormalized"       value="true"/>
<param name="GFTT/BlockSize"              value="3"/>
<param name="GFTT/K"                      value="0.04"/>
<param name="GFTT/MaxCorners"             value="1000"/>
<param name="GFTT/MinDistance"            value="1"/>
<param name="GFTT/QualityLevel"           value="0.01"/>
<param name="GFTT/UseHarrisDetector"      value="false"/>
<param name="Kp/BadSignRatio"             value="0.2"/>
<param name="Kp/DetectorStrategy"         value="0"/>
<param name="Kp/DictionaryPath"           value=""/>
<param name="Kp/IncrementalDictionary"    value="true"/>
<param name="Kp/NNStrategy"               value="1"/>
<param name="Kp/NndrRatio"                value="0.8"/>
<param name="Kp/Parallelized"             value="true"/>
<param name="Kp/PublishKeypoints"         value="true"/>
<param name="Kp/TfIdfLikelihoodUsed"      value="false"/>
<param name="Kp/WordsPerImage"            value="400"/>
<param name="LccReextract/FeatureType"    value="4"/>
<param name="LccReextract/LoopClosureFeatures" value="false"/>
<param name="LccReextract/MaxWords"       value="0"/>
<param name="LccReextract/NNDR"           value="0.7"/>
<param name="LccReextract/NNType"         value="3"/>
<param name="Mem/BadSignaturesIgnored"    value="false"/>
<param name="Mem/GenerateIds"             value="true"/>
<param name="Mem/ImageKept"               value="true"/>
<param name="Mem/IncrementalMemory"       value="true"/>
<param name="Mem/InitWMWithAllNodes"      value="false"/>
<param name="Mem/RecentWmRatio"           value="0.2"/>
<param name="Mem/RehearsalIdUpdatedToNewOne" value="false"/>
<param name="Mem/RehearsalSimilarity"     value="0.6"/>
<param name="Mem/RehearsedNodesKept"      value="true"/>
<param name="Mem/STMSize"                 value="10"/>
<param name="ORB/EdgeThreshold"           value="31"/>
<param name="ORB/FirstLevel"              value="0"/>
<param name="ORB/Gpu"                     value="false"/>
<param name="ORB/NFeatures"               value="500"/>
<param name="ORB/NLevels"                 value="8"/>
<param name="ORB/PatchSize"               value="31"/>
<param name="ORB/ScaleFactor"             value="1.2"/>
<param name="ORB/ScoreType"               value="0"/>
<param name="ORB/WTA_K"                   value="2"/>
<param name="RGBD/AngularUpdate"          value="0"/>   <!-- keep originals -->
<param name="RGBD/Enabled"                value="true"/>
<param name="RGBD/LinearUpdate"           value="0"/>
<param name="RGBD/LocalLoopDetectionMaxDiffID" value="0"/>
<param name="RGBD/LocalLoopDetectionNeighbors" value="20"/>
<param name="RGBD/LocalLoopDetectionRadius"    value="2"/>
<param name="RGBD/LocalLoopDetectionSpace"     value="false"/>
<param name="RGBD/LocalLoopDetectionTime"      value="false"/>
<param name="RGBD/NewMapOdomChangeDistance"    value="0"/>
<param name="RGBD/ScanMatchingSize"       value="0"/>
<param name="RGBD/ToroIterations"         value="100"/>
<param name="Rtabmap/DetectionRate"       value="0"/>
<param name="Rtabmap/ImageBufferSize"     value="0"/>
<param name="Rtabmap/LoopRatio"           value="0.9"/>
<param name="Rtabmap/LoopThr"             value="0.11"/>
<param name="Rtabmap/MaxRetrieved"        value="2"/>
<param name="Rtabmap/MemoryThr"           value="0"/>
<param name="Rtabmap/PublishImage"        value="true"/>
<param name="Rtabmap/PublishLikelihood"   value="true"/>
<param name="Rtabmap/PublishPdf"          value="true"/>
<param name="Rtabmap/PublishStats"        value="true"/>
<param name="Rtabmap/StatisticLogged"     value="false"/>
<param name="Rtabmap/StatisticLogsBufferedInRAM" value="true"/>
<param name="Rtabmap/TimeThr"             value="0"/>
<param name="Rtabmap/VhStrategy"          value="0"/>
<param name="SIFT/ContrastThreshold"      value="0.04"/>
<param name="SIFT/EdgeThreshold"          value="10"/>
<param name="SIFT/NFeatures"              value="0"/>
<param name="SIFT/NOctaveLayers"          value="3"/>
<param name="SIFT/Sigma"                  value="1.6"/>
<param name="SURF/Extended"               value="false"/>
<param name="SURF/GpuKeypointsRatio"      value="0.01"/>
<param name="SURF/GpuVersion"             value="false"/>
<param name="SURF/HessianThreshold"       value="60"/>
<param name="SURF/OctaveLayers"           value="2"/>
<param name="SURF/Octaves"                value="4"/>
<param name="SURF/Upright"                value="false"/>
<param name="VhEp/MatchCountMin"          value="8"/>
<param name="VhEp/RansacParam1"           value="3"/>
<param name="VhEp/RansacParam2"           value="0.99"/>

  </include>

  <!-- ================== Virtual Laser (PointCloud2 -> LaserScan) ================== -->
  <group if="$(arg virtual_scan)">
    <node pkg="depthimage_to_laserscan" type="depthimage_to_laserscan" name="depth_to_scan" output="screen">
      <remap from="image"       to="/camera/depth_registered/image_raw"/>
      <remap from="camera_info" to="/camera/depth_registered/camera_info"/>
      <remap from="scan"        to="/scan"/>
      <param name="range_max"   value="4.0"/>
      <param name="output_frame_id" value="base_link"/>
    </node>
  </group>
</launch>